# torgo: Advanced Multi-Instance Tor Controller with S6 Overlay

**torgo** is a Go application designed to manage multiple backend Tor instances, supervised by the S6 Overlay system for robustness. It provides unified SOCKS5 and DNS proxy interfaces with load balancing, an HTTP API for fine-grained control, a Web UI for monitoring, and includes features like automatic circuit rotation, IP diversity management, and DNS caching. It also bundles Privoxy (managed by S6) for easy HTTP-to-SOCKS5 bridging.

## Features

* **Multiple Backend Tor Instances**: Managed by S6 Overlay, number configurable via `TOR_INSTANCES`.
* **Common SOCKS5 Proxy**: Single entry point load balancing to Tor instances.
* **Common DNS Proxy**: Single entry point for DNS over Tor, with **DNS caching**.
* **Bundled Privoxy HTTP Proxy**: Runs as an S6 service, bridging HTTP to `torgo`'s SOCKS5.
* **S6 Overlay Supervision**: Manages Tor instances, Privoxy, and the main `torgo` Go application for resilience and automatic restarts.
* **Load Balancing**: Distributes SOCKS/DNS requests across healthy Tor instances.
* **Health Monitoring**: `torgo-app` periodically checks backend Tor instances.
* **Automatic Circuit Rotation & IP Diversity Management**.
* **Management API & Web UI**.
* **Dockerized**: Deployment with Docker and Docker Compose.

## Project Structure (Refined Modular Layout)

```
torgo/
├── cmd/torgo/
│   └── main.go
├── internal/
│   ├── api/
│   │   ├── handlers.go
│   │   ├── webui_handler.go
│   │   └── static_web_ui/      # <-- Web assets moved here
│   │       └── index.html      # (and any other .css, .js files)
│   ├── config/
│   │   └── config.go
│   ├── dns/
│   │   ├── cache.go
│   │   └── proxy.go
│   ├── socks/
│   │   └── proxy.go
│   ├── tor/
│   │   └── instance.go
│   ├── health/
│   │   └── monitor.go
│   ├── rotation/
│   │   ├── auto_monitor.go
│   │   └── diversity_monitor.go
│   └── lb/
│       └── loadbalancer.go
│
├── rootfs/                         # <-- For S6 Overlay files
│   └── etc/
│       └── s6-overlay/
│           ├── cont-init.d/
│           │   └── 01-tor-setup    # Tor instance setup script
│           └── s6-rc.d/
│               ├── user/
│               │   └── contents.d/
│               │       └── torgo-base # Lists core S6 managed services
│               ├── svc-privoxy/
│               │   ├── run           # Privoxy run script
│               │   └── up            # Empty file to enable service
│               └── svc-torgo-app/
│                   ├── run           # torgo-app run script
│                   └── up            # Empty file to enable service
│
├── Dockerfile                      # Updated for S6
├── docker-compose.yml
├── docker-healthcheck.sh
├── go.mod
├── go.sum                          # Will be generated by `go mod tidy`
├── privoxy_config
├── torrc.template                  # As updated previously
└── README.md  
```

## Prerequisites

* Docker
* Docker Compose

## Getting Started

1.  Ensure all project files (including the `rootfs` directory and its contents) are in place.
2.  **(Optional) Create a `.env` file** for custom environment variables.
3.  Build and run: `docker-compose up --build -d`

## Configuration

Key environment variables (see `docker-compose.yml` and `internal/config/config.go`):
* `TOR_INSTANCES`
* Ports: `API_PORT`, `COMMON_SOCKS_PROXY_PORT`, `COMMON_DNS_PROXY_PORT`, `PRIVOXY_HTTP_PORT`
* Base ports for Tor instances.
* Settings for rotation, health, IP diversity, DNS cache.

## Using torgo

* **SOCKS5 Proxy**: `127.0.0.1:<COMMON_SOCKS_PROXY_PORT>`
* **DNS Proxy**: `127.0.0.1:<COMMON_DNS_PROXY_PORT>`
* **HTTP Proxy (via Privoxy)**: `http://127.0.0.1:<PRIVOXY_MAPPED_PORT>`
* **Web UI**: `http://localhost:<API_PORT>/webui`

## S6 Overlay Notes

* The `01-tor-setup` script in `rootfs/etc/s6-overlay/cont-init.d/` dynamically creates S6 service definitions for each Tor instance based on `TOR_INSTANCES`.
* `svc-torgo-app` and `svc-privoxy` are defined statically.
* Logging for S6 services can be configured by adding `log/run` scripts within each service directory (e.g., `svc-torgo-app/log/run`) to use `s6-log`.

(Refer to the full `README.md` previously generated for API details, etc.)


