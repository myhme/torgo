services:
  torgo:
    build: .
    container_name: torgo-zt
    restart: unless-stopped
    # Use the specific user created in the Dockerfile
    user: "106:106"
    runtime: firecracker
    privileged: false
    read_only: true
    # Use host network to simplify network stack and avoid Docker bridge overhead
    # We bind directly to the WireGuard IP in the environment variables
    network_mode: host 
    
    tmpfs:
      - /var/lib/tor-temp:size=512m,mode=700,noexec,nosuid,nodev
      - /run:size=32m,noexec,nosuid,nodev
      - /tmp:size=64m,noexec,nosuid,nodev
    
    cap_drop:
      - ALL
    cap_add:
      # NET_ADMIN is the most dangerous capability and is LIKELY unnecessary
      # since we only bind ports and don't manage iptables or complex routing.
      - IPC_LOCK # REQUIRED for mlockall to protect sensitive memory
      - SYS_ADMIN    # needed for mount/unmount of encrypted devices
      - SYS_CHROOT

    security_opt:
      - no-new-privileges:true
    ulimits:
      memlock: -1 # Required for mlockall to prevent sensitive memory from being swapped
      core: 0
      
    environment:
      - SECMEM_REQUIRE_MLOCK=true
      - TOR_INSTANCES=8
      - TORGO_ENABLE_LUKS_RAM=1
      - TORGO_BLIND_CONTROLP=1
      - COMMON_SOCKS_PROXY_PORT=9150
      - COMMON_DNS_PROXY_PORT=5353

    healthcheck:
      test: ["CMD", "sh", "-c", "timeout 3 bash -c '</dev/tcp/127.0.0.1/9150'"]
      interval: 30s
      timeout: 5s
      retries: 5

    # Removed the 'networks' block as we are using 'network_mode: host'