services:
  torgo-gvisor:
    image: torgo-gvisor:latest  # Build with updated Dockerfile
    container_name: torgo-zt
    runtime: runsc  # gVisor syscall trap – host-proof
    restart: unless-stopped
    user: "1000:1000"  # Rootless: Your host UID/GID
    read_only: true
    tmpfs:
      - /var/lib/tor-temp:size=1g,mode=700,noexec,nosuid,nodev  # LUKS headroom (x8=8GB)
      - /run:size=64m,noexec,nosuid,nodev
      - /tmp:size=128m,noexec,nosuid,nodev
    cap_drop: [ALL]
    cap_add:
      - IPC_LOCK  # mlock keys
      - SYS_ADMIN  # LUKS (gVisor traps abuse)
      - SYS_CHROOT
    security_opt:
      - no-new-privileges:true
      - seccomp=unconfined  # gVisor owns filtering – kills exploits
    ulimits:
      memlock: -1
      core: 0
      nofile: 1024  # Low for DoS-proof
    environment:
      - SECMEM_REQUIRE_MLOCK=true
      - SECMEM_STRICT=1  # Fatal on hardening fails
      - TOR_INSTANCES=8
      - TORGO_ENABLE_LUKS_RAM=1  # Per-inst encryption
      - TORGO_BLIND_CONTROLP=1    # No cookies/ports
      - COMMON_SOCKS_PROXY_PORT=9150
      - COMMON_DNS_PROXY_PORT=5353
    healthcheck:
      test: ["CMD-SHELL", "timeout 3 bash -c 'echo > /dev/tcp/127.0.0.1/9150' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    # Rootless net: Host mode for Tor binds (gVisor isolates packets)
    network_mode: host
    # Scale hint: --scale=8 in nerdctl