version: '3.8'

services:
  torgo:
    build:
      context: . 
      dockerfile: Dockerfile
    container_name: torgo_service
    ports:
      - "${API_PORT:-8080}:${API_PORT:-8080}" 
      - "${COMMON_SOCKS_PROXY_PORT:-9000}:${COMMON_SOCKS_PROXY_PORT:-9000}" 
      - "${COMMON_DNS_PROXY_PORT:-5300}:${COMMON_DNS_PROXY_PORT:-5300}/tcp" 
      - "${COMMON_DNS_PROXY_PORT:-5300}:${COMMON_DNS_PROXY_PORT:-5300}/udp" 
    environment:
      - TOR_INSTANCES=${TOR_INSTANCES:-3} 

      - SOCKS_BASE_PORT_CONFIGURED=${SOCKS_BASE_PORT_CONFIGURED:-9050}
      - CONTROL_BASE_PORT_CONFIGURED=${CONTROL_BASE_PORT_CONFIGURED:-9160}
      - DNS_BASE_PORT_CONFIGURED=${DNS_BASE_PORT_CONFIGURED:-9200}

      - COMMON_SOCKS_PROXY_PORT=${COMMON_SOCKS_PROXY_PORT:-9000}
      - COMMON_DNS_PROXY_PORT=${COMMON_DNS_PROXY_PORT:-5300}
      - API_PORT=${API_PORT:-8080} 

      - ROTATION_STAGGER_DELAY_SECONDS=${ROTATION_STAGGER_DELAY_SECONDS:-15}
      - HEALTH_CHECK_INTERVAL_SECONDS=${HEALTH_CHECK_INTERVAL_SECONDS:-45}
      - IP_CHECK_URL=${IP_CHECK_URL:-https://check.torproject.org/api/ip}
      - SOCKS_TIMEOUT_SECONDS=${SOCKS_TIMEOUT_SECONDS:-15}
      
      # New ENVs for IP Diversity
      - IP_DIVERSITY_CHECK_INTERVAL_SECONDS=${IP_DIVERSITY_CHECK_INTERVAL_SECONDS:-300} # 5 minutes
      - IP_DIVERSITY_ROTATION_COOLDOWN_SECONDS=${IP_DIVERSITY_ROTATION_COOLDOWN_SECONDS:-900} # 15 minutes
      - MIN_INSTANCES_FOR_IP_DIVERSITY_CHECK=${MIN_INSTANCES_FOR_IP_DIVERSITY_CHECK:-2} # Min 2 instances to check for similarity

    sysctls: 
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.default.disable_ipv6=1
      - net.ipv6.conf.lo.disable_ipv6=1
    restart: unless-stopped
