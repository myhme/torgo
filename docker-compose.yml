version: "3.9"

services:
  torgo:
    build: .
    container_name: torgo-zt
    restart: unless-stopped

    # Run as tor user (matches /etc/passwd from Alpine tor)
    user: "106:112"

    privileged: false
    read_only: true
    network_mode: host

    # All writable paths are tmpfs â†’ RAM only
    tmpfs:
      - /var/lib/tor-temp:size=512m,mode=700,noexec,nosuid,nodev
      - /var/lib/tor:size=256m,mode=700,noexec,nosuid,nodev
      - /run:size=32m,noexec,nosuid,nodev
      - /tmp:size=64m,noexec,nosuid,nodev

    volumes:
      - ./torrc.template:/etc/tor/torrc.template:ro
      - ./seccomp.json:/etc/torgo/seccomp.json:ro

    ports:
      - "9150:9150/tcp"   # SOCKS
      - "5353:5353/udp"   # DNS

    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK    # secmem: mlockall
      - SYS_ADMIN   # cryptsetup + mount/umount for LUKS RAM
      - SYS_CHROOT  # some cryptsetup paths

    security_opt:
      - no-new-privileges:true
      - seccomp=/etc/torgo/seccomp.json
      - apparmor=docker-tor-hardened

    ulimits:
      memlock: -1
      core: 0

    environment:
      SECMEM_REQUIRE_MLOCK: "true"
      # zero-trust config flags
      TOR_INSTANCES: "8"
      TORGO_ENABLE_LUKS_RAM: "1"
      TORGO_BLIND_CONTROLP: "1"
      COMMON_SOCKS_BIND_ADDR: "0.0.0.0"
      COMMON_SOCKS_PROXY_PORT: "9150"
      COMMON_DNS_PROXY_PORT: "5353"

    healthcheck:
      test: ["CMD", "sh", "-c", "timeout 3 bash -c '</dev/tcp/127.0.0.1/9150'"]
      interval: 30s
      timeout: 5s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
