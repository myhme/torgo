services:
proxy:
    image: ghcr.io/myhme/torgo:main
    container_name: proxy
    restart: always
    profiles:
      - "vpn-proxy"
      - "mediaserver"
    labels:
      - "com.priority=15"
      - "homepage.group=Proxies & Tunnels"
      - "homepage.name=TorGo Proxy"
      - "homepage.icon=tor.png"
      - "homepage.description=Tor Proxy Manager"
    # Run as unprivileged tor user (UID 100:GID 101 is standard for Alpine tor)
    user: "100:101"
    privileged: false
    read_only: true
    depends_on:
      adguardhome_essential:
        condition: service_healthy
    # Drop ALL capabilities to ensure Zero Trust / Least Privilege
    cap_drop:
      - ALL
    # Only minimal capabilities retained
    cap_add:
      - IPC_LOCK    # Required for SECMEM_REQUIRE_MLOCK=true (prevent swap)
      # SYS_ADMIN and SYS_CHROOT are NO LONGER REQUIRED (LUKS removed)
    ulimits:
      nofile: 65536
      memlock:
        soft: -1
        hard: -1
      core: 0
    # All writable paths are tmpfs → RAM only (no persistence, no disk trace)
    # All writable paths are tmpfs → RAM only (no persistence, no disk trace)
    # ADDED: uid=100,gid=101 to ensure the non-root user can write to them
    tmpfs:
      - /var/lib/tor-temp:size=512m,mode=700,uid=100,gid=101,noexec,nosuid,nodev
      - /var/lib/tor:size=256m,mode=700,uid=100,gid=101,noexec,nosuid,nodev
      - /run:size=32m,uid=100,gid=101,noexec,nosuid,nodev
      - /tmp:size=64m,uid=100,gid=101,noexec,nosuid,nodev
    security_opt:
      - no-new-privileges:true
      # Ensure these files exist on your HOST at these paths:
      - seccomp=/opt/docker-seccomp/torgo-seccomp.json
      - apparmor=docker-tor-hardened
    environment:
      # Hard memory rules
      - SECMEM_REQUIRE_MLOCK=true
      # Core pool sizing
      - TOR_INSTANCES=8
      # Privacy & Control
      - TORGO_BLIND_CONTROL=1
      # Bind addresses / ports (inside container)
      - COMMON_SOCKS_BIND_ADDR=0.0.0.0
      - COMMON_SOCKS_PROXY_PORT=9150
      - COMMON_DNS_PROXY_PORT=53
      # Connection limits (overall + per instance)
      - TORGO_MAX_CONNS_PER_INSTANCE=64   # per-instance cap
      - TORGO_MAX_TOTAL_CONNS=512         # global cap
      # Rotation policy (Chaos vs Stability)
      - TORGO_ROTATE_CONNS=64
      - TORGO_ROTATE_SECS=3600            # 1 hour max lifetime
      # DNS concurrency
      - TORGO_DNS_MAX_CONNS=256
      - TORGO_DNS_MAX_PER_INST=64
      # Timing jitter (Anti-fingerprinting)
      - TORGO_SOCKS_JITTER_MS_MAX=40
    networks:
      public:
        ipv4_address: 10.10.1.50
    # Healthcheck uses the internal Go binary check
    healthcheck:
      test: ["CMD", "/usr/local/bin/torgo", "--selfcheck"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      options:
        max-size: "10m"
        max-file: "3"