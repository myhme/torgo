<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>torgo Web UI - Control Panel</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #1c1e21; line-height: 1.6; }
        header { text-align: center; margin-bottom: 30px; padding-bottom:20px; border-bottom: 1px solid #dddfe2;}
        h1 { color: #1877f2; font-size: 2.2em; margin-bottom: 8px;}
        h2 { border-bottom: 1px solid #dddfe2; padding-bottom: 10px; margin-top: 35px; font-size: 1.6em; color: #333; }
        .container { max-width: 1200px; margin: auto; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05), 0 8px 16px rgba(0,0,0,0.05); }
        .instance-card { border: 1px solid #dddfe2; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #f9f9f9; box-shadow: 0 1px 2px rgba(0,0,0,0.03); transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .instance-card:hover { box-shadow: 0 5px 10px rgba(0,0,0,0.07); transform: translateY(-2px); }
        .status-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .status-healthy { background-color: #42b72a; }
        .status-unhealthy { background-color: #fa3e3e; }
        .status-unknown { background-color: #ffba00; }
        button { padding: 9px 18px; margin-top: 12px; margin-right: 10px; border: none; border-radius: 6px; cursor: pointer; background-color: #1877f2; color: white; font-size: 0.95em; font-weight: 500; transition: background-color 0.2s, box-shadow 0.2s; }
        button:hover { background-color: #166fe5; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:disabled { background-color: #ccd0d5; color: #8a8d91; cursor: not-allowed; box-shadow: none;}
        .btn-small { padding: 7px 12px; font-size: 0.85em; margin-top: 8px;}
        .loading-spinner { border: 2px solid #f3f3f3; border-top: 2px solid #1877f2; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre { background-color: #f0f2f5; padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; border: 1px solid #dddfe2; max-height: 400px;}
        #statsModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border: 1px solid #dddfe2; width: 90%; max-width: 800px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .close-button { color: #aaa; float: right; font-size: 32px; font-weight: bold; line-height: 0.7; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .info-label { font-weight: 600; color: #606770; min-width:130px; display:inline-block;}
        .info-value { font-family: Menlo, Monaco, Consolas, "Courier New", monospace; color: #1c1e21; font-size: 0.95em; }
        .card-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top:15px; border-top: 1px solid #e7e7e7; padding-top: 15px;}
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; }
        .app-config-details p { margin: 8px 0; font-size: 1em; }
        .error-message { color: #fa3e3e; font-weight: 500; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(20px); font-size: 0.9em; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background-color: #d9534f; }
        .toast.success { background-color: #5cb85c; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>torgo Control Panel</h1><p>Manage and Monitor Your Tor Instances</p></header>
        <section class="app-config-section">
            <h2>Application Configuration</h2>
            <div id="appConfigDetailsContainer" class="app-config-details"><p>Loading app configuration...</p></div>
        </section>
        <section class="status-section">
            <h2>Common Proxy Status</h2>
            <p><span class="info-label">SOCKS5 Proxy:</span> <span id="commonSocksPortDisplay" class="info-value">N/A</span> - Status: <span id="commonSocksStatus">Loading...</span></p>
            <p><span class="info-label">DNS Proxy:</span> <span id="commonDnsPortDisplay" class="info-value">N/A</span> - Status: <span id="commonDnsStatus">Loading...</span></p>
            <p>Last updated: <span id="lastUpdatedTimestamp" class="info-value">Never</span> <button id="refreshAllButton">Refresh All Data</button></p>
        </section>
        <section class="instances-section">
            <h2>Tor Instances (<span id="instanceCount">0</span>)</h2>
            <button id="rotateAllStaggeredButton">Rotate All Healthy Staggered</button>
            <div id="instancesContainer" class="grid-container"></div>
        </section>
        <div id="statsModal"><div class="modal-content"><span class="close-button" id="closeModalButton">&times;</span><h3 id="modalTitle">Instance Stats</h3><pre id="modalStatsContent">Loading...</pre></div></div>
    </div>
    <div id="toast-container"></div>
    <script>
        const API_BASE_URL = `${window.location.origin}/api/v1`;
        let appDetails = null; const instancesData = {}; let refreshIntervalId = null;
        const REFRESH_INTERVAL_MS = 25000;
        const dom = {
            appConfig: document.getElementById('appConfigDetailsContainer'),
            socksPort: document.getElementById('commonSocksPortDisplay'),
            socksStatus: document.getElementById('commonSocksStatus'),
            dnsPort: document.getElementById('commonDnsPortDisplay'),
            dnsStatus: document.getElementById('commonDnsStatus'),
            instances: document.getElementById('instancesContainer'),
            instanceCount: document.getElementById('instanceCount'),
            lastUpdated: document.getElementById('lastUpdatedTimestamp'),
            refreshBtn: document.getElementById('refreshAllButton'),
            rotateAllBtn: document.getElementById('rotateAllStaggeredButton'),
            modal: document.getElementById('statsModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalStatsContent'),
            closeModalBtn: document.getElementById('closeModalButton'),
            toastContainer: document.getElementById('toast-container')
        };
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.textContent = message;
            dom.toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, duration);
        }
        function formatTimeAgo(dateStr) {
            if (!dateStr || dateStr.startsWith("0001-01-01")) return "Never";
            const date = new Date(dateStr); const now = new Date();
            const secs = Math.round((now - date) / 1000);
            if (secs < 5) return "Just now"; if (secs < 60) return `${secs}s ago`;
            const mins = Math.round(secs / 60); if (mins < 60) return `${mins}m ago`;
            const hrs = Math.round(mins / 60); if (hrs < 24) return `${hrs}h ago`;
            return `${Math.round(hrs / 24)}d ago`;
        }
        function formatDuration(s) {
            if (s === 0 && typeof s === 'number') return "Disabled"; if (!s) return "N/A";
            if (s < 60) return `${s}s`; const m = Math.floor(s / 60); const remS = s % 60;
            return remS === 0 ? `${m}m` : `${m}m ${remS}s`;
        }
        async function fetchData(path, opts = {}) {
            try {
                const resp = await fetch(`${API_BASE_URL}${path}`, opts);
                if (!resp.ok) { const txt = await resp.text(); throw new Error(`HTTP ${resp.status}: ${txt.substring(0,100)}`); }
                const type = resp.headers.get("content-type");
                return type && type.includes("application/json") ? await resp.json() : { plain_text_response: await resp.text() };
            } catch (e) { showToast(`Error fetching ${path.split('/').pop()}: ${e.message}`, 'error'); return { error: e.message }; }
        }
        async function postData(path, body = null) {
            const opts = { method: 'POST' };
            if (body) { opts.headers = { 'Content-Type': 'application/json' }; opts.body = JSON.stringify(body); }
            try {
                const resp = await fetch(`${API_BASE_URL}${path}`, opts);
                const txt = await resp.text();
                if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${txt}`);
                try { return JSON.parse(txt); } catch (e) { return txt; }
            } catch (e) { showToast(`Error on ${path.split('/')[1] || 'all'}: ${e.message.substring(0,50)}`, 'error'); return { error: e.message }; }
        }
        function createInstanceCard(id) {
            if (document.getElementById(`instance-${id}-card`)) return;
            const card = document.createElement('div'); card.id = `instance-${id}-card`; card.className = 'instance-card';
            card.innerHTML = `<h3>Instance ${id}</h3>
                <p><span class="info-label">Status:</span> <span id="instance-${id}-status-dot" class="status-dot status-unknown"></span><span id="instance-${id}-status-text">Loading...</span></p>
                <p><small><span class="info-label">External IP:</span> <span id="instance-${id}-ip" class="info-value">Loading...</span> <button id="refresh-ip-btn-${id}" class="btn-small" title="Refresh IP">ðŸ”„ IP</button></small></p>
                <p><small><span class="info-label">IP Last Change:</span> <span id="instance-${id}-ip-change-time" class="info-value">N/A</span></small></p>
                <p><small><span class="info-label">Circuit Last Rec.:</span> <span id="instance-${id}-circuit-rec-time" class="info-value">N/A</span></small></p><hr style="border:0; border-top: 1px solid #eee; margin: 12px 0;">
                <p><small><span class="info-label">Control:</span> <span id="instance-${id}-control" class="info-value">N/A</span></small></p>
                <p><small><span class="info-label">SOCKS:</span> <span id="instance-${id}-socks" class="info-value">N/A</span></small></p>
                <p><small><span class="info-label">DNS:</span> <span id="instance-${id}-dns" class="info-value">N/A</span></small></p>
                <p><small><span class="info-label">Bootstrap:</span> <span id="instance-${id}-bootstrap" class="info-value">N/A</span></small></p>
                <p><small><span class="info-label">Version:</span> <span id="instance-${id}-version" class="info-value">N/A</span></small></p>
                <div class="card-actions">
                    <button id="rotate-btn-${id}">New Circuit <span id="rotate-spinner-${id}" class="loading-spinner" style="display:none;"></span></button>
                    <button id="stats-btn-${id}">View Stats</button> <button id="refresh-instance-btn-${id}" class="btn-small">Refresh Data</button>
                </div>`;
            dom.instances.appendChild(card);
            document.getElementById(`rotate-btn-${id}`).addEventListener('click', () => handleNewCircuitClick(id));
            document.getElementById(`stats-btn-${id}`).addEventListener('click', () => showFullStats(id));
            document.getElementById(`refresh-instance-btn-${id}`).addEventListener('click', () => { showToast(`Refreshing instance ${id}...`, 'info', 1500); fetchAndRenderInstanceData(id); });
            document.getElementById(`refresh-ip-btn-${id}`).addEventListener('click', async () => {
                document.getElementById(`instance-${id}-ip`).textContent = 'Fetching IP...';
                showToast(`Fetching IP for instance ${id}...`, 'info', 2000);
                await fetchData(`/tor${id}/ip`);
                const configData = await fetchData(`/tor${id}/config`);
                instancesData[id] = { ...instancesData[id], config: configData };
                updateInstanceCardUI(id, instancesData[id]);
            });
        }
        function updateInstanceCardUI(id, data) {
            const el = suffix => document.getElementById(`instance-${id}-${suffix}`);
            if (!el('status-dot')) return;
            if (data?.health && !data.health.error) {
                el('status-dot').className = data.health.cached_is_healthy ? 'status-dot status-healthy' : 'status-dot status-unhealthy';
                el('status-text').textContent = data.health.cached_is_healthy ? 'Healthy' : 'Unhealthy';
                if (data.health.last_health_check_at) el('status-text').textContent += ` (checked ${formatTimeAgo(data.health.last_health_check_at)})`;
            } else { el('status-dot').className = 'status-dot status-unknown'; el('status-text').textContent = (data?.health?.error) ? `Error: ${data.health.error}` : 'Health N/A'; }
            if (data?.config && !data.config.error) {
                el('ip').textContent = data.config.external_ip || 'N/A';
                el('ip-change-time').textContent = formatTimeAgo(data.config.last_ip_change_at);
                el('circuit-rec-time').textContent = formatTimeAgo(data.config.last_circuit_recreation_at);
                el('control').textContent = data.config.control_host || 'N/A'; el('socks').textContent = data.config.backend_socks_host || 'N/A'; el('dns').textContent = data.config.backend_dns_host || 'N/A';
            } else { ['ip', 'ip-change-time', 'circuit-rec-time', 'control', 'socks', 'dns'].forEach(s => el(s).textContent = 'N/A'); if (data?.config?.error) el('ip').textContent = `Config Err`; }
            if (data?.stats && !data.stats.error) {
                const bs = data.stats.bootstrap_status ? data.stats.bootstrap_status.match(/SUMMARY="([^"]+)"/) : null;
                el('bootstrap').textContent = bs ? bs[1] : (data.stats.bootstrap_status || 'N/A');
                if (data.stats.bootstrap_error) el('bootstrap').textContent += ` (Error: ${data.stats.bootstrap_error})`;
                el('version').textContent = data.stats.version || "N/A";
                if (data.stats.version_error) el('version').textContent += ` (Error: ${data.stats.version_error})`;
            } else { el('bootstrap').textContent = (data?.stats?.error) ? `Stats Err` : 'N/A'; el('version').textContent = "N/A"; }
        }
        async function showFullStats(id) {
            dom.modalTitle.textContent = `Full Stats for Instance ${id}`; dom.modalContent.textContent = 'Loading...'; dom.modal.style.display = "block";
            const stats = await fetchData(`/tor${id}/stats`);
            dom.modalContent.textContent = stats.error ? `Error: ${stats.error}` : JSON.stringify(stats, null, 2);
        }
        dom.closeModalBtn.onclick = () => { dom.modal.style.display = "none"; }
        window.onclick = (e) => { if (e.target == dom.modal) dom.modal.style.display = "none"; }

        async function handleNewCircuitClick(id) {
            const btn = document.getElementById(`rotate-btn-${id}`); const spin = document.getElementById(`rotate-spinner-${id}`);
            btn.disabled = true; spin.style.display = 'inline-block'; showToast(`Requesting new circuit for instance ${id}...`, 'info', 2000);
            const result = await postData(`/tor${id}/rotate`);
            if (result.error) showToast(`Error for instance ${id} circuit: ${result.error.message || result.error}`, 'error');
            else { showToast(`Instance ${id}: New circuit requested. Resp: ${String(result).substring(0,30)}...`, 'success'); setTimeout(() => fetchAndRenderInstanceData(id), 1500); }
            btn.disabled = false; spin.style.display = 'none';
        }
        dom.rotateAllBtn.onclick = async function() {
            this.disabled = true; this.textContent = "Rotating All (Streaming)..."; showToast("Initiating staggered rotation...", 'info', 3000);
            try {
                const resp = await fetch(`${API_BASE_URL}/rotate-all-staggered`, { method: 'POST' });
                if (!resp.ok) { const txt = await resp.text(); throw new Error(`HTTP ${resp.status}: ${txt}`); }
                showToast(`Staggered rotation initiated. Monitor UI/logs.`, 'success', 5000);
            } catch (e) { showToast(`Error initiating staggered rotation: ${e.message}`, 'error'); }
            this.disabled = false; this.textContent = "Rotate All Healthy Staggered";
            setTimeout(() => fetchAndRenderAllInstances(), 5000);
        }
        function updateCommonProxyStatusDisplay() {
            if (!appDetails) { dom.socksStatus.textContent = 'Loading...'; dom.dnsStatus.textContent = 'Loading...'; return; }
            dom.socksPort.textContent = appDetails.common_socks_port || 'N/A'; dom.dnsPort.textContent = appDetails.common_dns_port || 'N/A';
            const configInstances = parseInt(appDetails.num_instances, 10) || 0;
            if (configInstances === 0) { dom.socksStatus.innerHTML = dom.dnsStatus.innerHTML = 'No instances.'; return; }
            let healthyCount = 0;
            for (let i = 1; i <= configInstances; i++) { if (instancesData[i]?.health?.cached_is_healthy === true) healthyCount++; }
            const statusHTML = healthyCount > 0 ? `<span class="status-dot status-healthy"></span>Operational (${healthyCount}/${configInstances} healthy)` : `<span class="status-dot status-unhealthy"></span>Offline (0/${configInstances} healthy)`;
            dom.socksStatus.innerHTML = dom.dnsStatus.innerHTML = statusHTML;
        }
        function renderAppConfigDetails(details) {
            if (!details || details.error) { dom.appConfig.innerHTML = '<p class="error-message">Error loading app config.</p>'; return; }
            let html = `<p><span class="info-label">Tor Instances:</span> <span class="info-value">${details.num_instances}</span></p>
                        <p><span class="info-label">API Port:</span> <span class="info-value">${details.api_port}</span></p>
                        <p><span class="info-label">Health Check:</span> <span class="info-value">${formatDuration(details.health_check_interval_seconds)}</span></p>
                        <p><span class="info-label">IP Diversity:</span> <span class="info-value">${formatDuration(details.ip_diversity_check_interval_seconds)} (Cooldown: ${formatDuration(details.ip_diversity_rotation_cooldown_seconds)})</span></p>
                        <p><span class="info-label">Auto Rotation:</span> <span class="info-value">${details.auto_rotation_enabled ? 'Enabled' : 'Disabled'}</span></p>`;
            if (details.auto_rotation_enabled) {
                html += `<p><span class="info-label">Auto Rot. Interval:</span> <span class="info-value">${formatDuration(details.auto_rotate_circuit_interval_seconds)}</span></p>
                         <p><span class="info-label">Auto Rot. Stagger:</span> <span class="info-value">${formatDuration(details.auto_rotate_stagger_delay_seconds)}</span></p>`;
            }
            html += `<p><span class="info-label">Manual Stagger:</span> <span class="info-value">${formatDuration(details.rotation_stagger_delay_seconds)}</span></p>
                     <p><span class="info-label">DNS Cache:</span> <span class="info-value">${details.dns_cache_enabled ? 'Enabled' : 'Disabled'}</span></p>
                     <p><span class="info-label">DNS Timeout:</span> <span class="info-value">${formatDuration(details.dns_timeout_seconds)}</span></p>`;
            dom.appConfig.innerHTML = html;
        }
        async function fetchAndRenderInstanceData(id) {
            createInstanceCard(id);
            try {
                const [config, health, stats] = await Promise.all([fetchData(`/tor${id}/config`), fetchData(`/tor${id}/health`), fetchData(`/tor${id}/stats`)]);
                instancesData[id] = { config, health, stats }; updateInstanceCardUI(id, instancesData[id]);
            } catch (e) { showToast(`Failed to fetch data for instance ${id}`, 'error'); updateInstanceCardUI(id, {config: {error: 'Fetch failed'}, health: {error: 'Fetch failed'}, stats: {error: 'Fetch failed'}}); }
        }
        async function fetchAndRenderAllInstances() {
            dom.refreshBtn.disabled = true; dom.refreshBtn.innerHTML = 'Refreshing... <span class="loading-spinner"></span>';
            const details = await fetchData("/app-details");
            appDetails = (details.error || typeof details.num_instances === 'undefined') ?
                { num_instances: 0, common_socks_port: 'N/A', common_dns_port: 'N/A', api_port: 'N/A' } : details;
            if(details.error) showToast("Failed to load app details.", "error");
            renderAppConfigDetails(appDetails); dom.instanceCount.textContent = appDetails.num_instances || 0;
            const numInst = appDetails.num_instances || 0;
            if (numInst === 0) dom.instances.innerHTML = '<p>No Tor instances configured.</p>';
            else {
                dom.instances.querySelectorAll('.instance-card').forEach(card => {
                    const cardIdNum = parseInt(card.id.split('-')[1]);
                    if (cardIdNum > numInst) { card.remove(); delete instancesData[cardIdNum]; }
                });
                const promises = [];
                for (let i = 1; i <= numInst; i++) { createInstanceCard(i); promises.push(fetchAndRenderInstanceData(i)); }
                await Promise.allSettled(promises);
            }
            updateCommonProxyStatusDisplay(); dom.lastUpdated.textContent = new Date().toLocaleTimeString();
            dom.refreshBtn.disabled = false; dom.refreshBtn.innerHTML = 'Refresh All Data';
        }
        dom.refreshBtn.addEventListener('click', () => { showToast("Refreshing all data...", 'info', 1500); fetchAndRenderAllInstances(); });
        document.addEventListener('DOMContentLoaded', async () => { await fetchAndRenderAllInstances(); if (refreshIntervalId) clearInterval(refreshIntervalId); refreshIntervalId = setInterval(fetchAndRenderAllInstances, REFRESH_INTERVAL_MS); });
    </script>
</body>
</html>
