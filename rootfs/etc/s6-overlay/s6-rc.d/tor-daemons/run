#!/command/with-contenv bash
set -e
echo "--- S6 Service: Starting Tor Daemons ---"

# --- Environment Variable Processing ---
export TOR_INSTANCES=${TOR_INSTANCES:-1}
SOCKS_BASE_PORT_CONFIGURED=${SOCKS_BASE_PORT_CONFIGURED:-9050}
CONTROL_BASE_PORT_CONFIGURED=${CONTROL_BASE_PORT_CONFIGURED:-9160}
DNS_BASE_PORT_CONFIGURED=${DNS_BASE_PORT_CONFIGURED:-9200}
TOR_USER="_tor"
TOR_DATA_BASE_DIR="/var/lib/tor"
TOR_RUN_DIR="/var/run/tor"
TORRC_TEMPLATE_PATH="/etc/tor/torrc.template"
TORRC_DIR="/run/tor"

# Ensure required runtime user exists (cannot be created on read-only rootfs)
if ! getent passwd "${TOR_USER}" >/dev/null 2>&1; then
  echo "FATAL: Required user '${TOR_USER}' not found. Rebuild the image to include it."
  exit 1
fi

# --- Tor Instance Setup ---
if ! [[ "$TOR_INSTANCES" =~ ^[0-9]+$ ]] || [ "$TOR_INSTANCES" -lt 1 ]; then
    TOR_INSTANCES=1
fi
echo "Tor Daemons Service: Preparing to start $TOR_INSTANCES Tor instance(s)..."

mkdir -p "$TOR_RUN_DIR" "$TOR_DATA_BASE_DIR" "$TORRC_DIR"
chown -R "${TOR_USER}:${TOR_USER}" "$TOR_RUN_DIR" "$TOR_DATA_BASE_DIR"
chmod 700 "$TOR_RUN_DIR" "$TOR_DATA_BASE_DIR"

for i in $(seq 1 "$TOR_INSTANCES"); do
    DATA_DIR="${TOR_DATA_BASE_DIR}/instance${i}"
    TORRC_FILE="${TORRC_DIR}/torrc.${i}"
    
    echo "Tor Daemons Service: Configuring Tor instance $i..."
    mkdir -p "$DATA_DIR"
    chown -R "${TOR_USER}:${TOR_USER}" "$DATA_DIR"
    chmod 700 "$DATA_DIR"

    EXTRA_OPTIONS=""
    if [ -n "$TOR_EXIT_NODES" ]; then
        EXTRA_OPTIONS="${EXTRA_OPTIONS}ExitNodes $TOR_EXIT_NODES\nStrictNodes 1\n"
    fi
    if [ -n "$TOR_MAX_CIRCUIT_DURTINESS" ]; then
        EXTRA_OPTIONS="${EXTRA_OPTIONS}MaxCircuitDirtiness $TOR_MAX_CIRCUIT_DURTINESS\n"
    fi
    
    # Create the final torrc file for this instance
    sed -e "s|__DATADIR__|${DATA_DIR}|g" \
        -e "s|__SOCKSPORT__|127.0.0.1:$((SOCKS_BASE_PORT_CONFIGURED + i))|g" \
        -e "s|__CONTROLPORT__|127.0.0.1:$((CONTROL_BASE_PORT_CONFIGURED + i))|g" \
        -e "s|__DNSPORT__|127.0.0.1:$((DNS_BASE_PORT_CONFIGURED + i))|g" \
        -e "s|__PIDFILE__|/dev/null|g" \
        -e "s|__EXTRA_TOR_OPTIONS__|${EXTRA_OPTIONS}|g" \
        "${TORRC_TEMPLATE_PATH}" > "${TORRC_FILE}"
    chmod 644 "${TORRC_FILE}"

    # Start the daemon for this instance, managed by exec
    # We use s6-setuidgid to drop privileges to the _tor user
    echo "Tor Daemons Service: Starting Tor instance $i..."
    s6-setuidgid _tor tor -f "${TORRC_FILE}" &
done

# Wait for all background tor processes to finish
# If one fails, this script will exit, and S6 will restart the service.
wait
